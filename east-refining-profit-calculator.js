function calculateProfits(){const itemsCosts={};const fee=document.querySelector('#fee').value*1||0;var returnRate=document.querySelector('#return-rate').value*1||0;var craftAmount=document.querySelector('#craft-amount').value*1||1;var masteries={4:document.querySelector('#spec-t4').value*1||0,5:document.querySelector('#spec-t5').value*1||0,6:document.querySelector('#spec-t6').value*1||0,7:document.querySelector('#spec-t7').value*1||0,8:document.querySelector('#spec-t8').value*1||0}
document.querySelectorAll('#prices-table tbody tr').forEach(function(node){const inputs=node.querySelectorAll('input');inputs.forEach(input=>{const itemId=input.getAttribute('data-item-id');if(itemsCosts[itemId]){return;}
itemsCosts[itemId]=input.value*1;});});document.querySelectorAll('#refining-table tbody tr').forEach(function(node){const product=JSON.parse(node.getAttribute('data-product'));const productPrice=itemsCosts[product._marketplaceTitle];const itemFee=Math.ceil((product._calculatedItemValue*0.1125*fee)/100);product.craftingrequirements.forEach((recipe,recipeIndex)=>{let missingResourcePrice=false;let resourceCosts=0;let profit=0;recipe.craftresource.forEach(resource=>{if(!itemsCosts[resource._marketplaceTitle])return missingResourcePrice=true;const cost=itemsCosts[resource._marketplaceTitle]*resource._attr.count;resourceCosts+=cost;});if(!missingResourcePrice&&productPrice){profit=((productPrice*recipe._attr.amountcrafted)-resourceCosts+(resourceCosts/100*returnRate)-itemFee)*craftAmount;}
const baseMasteries=(masteries[4]+masteries[5]+masteries[6]+masteries[7]+masteries[8])*0.3
const idx=product._attr.tier*1;const specialty=masteries[idx]*2.5||0;const focusRequired=Math.round(recipe._attr.craftingfocus*Math.pow(0.5,(specialty+baseMasteries)/100)*craftAmount);const profitFocusRatio=profit/focusRequired;node.querySelector(`#recipe-${product._marketplaceTitle.replace('@','___')}-${recipeIndex}-focus-cost`).textContent=focusRequired.toFixed(0);node.querySelector(`#recipe-${product._marketplaceTitle.replace('@','___')}-${recipeIndex}-focus-cost`).style.color=focusRequired>=30000?'red':null;node.querySelector(`#recipe-${product._marketplaceTitle.replace('@','___')}-${recipeIndex}-profit`).textContent=profit.toFixed(0);node.querySelector(`#recipe-${product._marketplaceTitle.replace('@','___')}-${recipeIndex}-profit`).style.color=profit>0?'green':'red';node.querySelector(`#recipe-${product._marketplaceTitle.replace('@','___')}-${recipeIndex}-profit-per-focus`).textContent=profitFocusRatio.toFixed(2);node.querySelector(`#recipe-${product._marketplaceTitle.replace('@','___')}-${recipeIndex}-profit-per-focus`).style.color=profitFocusRatio>0?'green':'red';});});}
function resetPrices(marketItems){marketItems.forEach(function(item){$('[data-item-id=":item"]'.replace(':item',item)).val(0);});}
function getMarketPrices(type){var marketItems=[];$('input').each(function(){if(!$(this).data('item-id'))return;marketItems.push($(this).data('item-id'));});marketItems=_.uniq(marketItems);var marketCity=document.querySelector('#market-city').value
resetPrices(marketItems);if(type==='current'){$.get('https://east.albion-online-data.com/api/v1/stats/prices/'+marketItems.join(','),function(response){response.forEach(function(cityItem){if(!cityItem.sell_price_min)return;if(cityItem.city!==marketCity)return;$('[data-item-id=":item"]'.replace(':item',cityItem.item_id)).val(cityItem.sell_price_min);});calculateProfits();});}
if(type==='average'){marketItems.forEach(function(item){$.get('https://east.albion-online-data.com/api/v1/stats/charts/'+item,function(response){var cityItem=response.find(function(cityItem){return cityItem.location===marketCity;});if(!cityItem)return;$('[data-item-id=":item"]'.replace(':item',item)).val(cityItem.data.prices_avg[cityItem.data.prices_avg.length-1]);calculateProfits();});});}}
document.querySelectorAll('input').forEach(function(node){node.oninput=calculateProfits;});